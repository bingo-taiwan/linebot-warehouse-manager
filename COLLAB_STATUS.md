# å€‰ç®¡å°å¹«æ‰‹ (Warehouse Bot) é–‹ç™¼èˆ‡ç¶­ä¿®æ—¥èªŒ

## ğŸ“… ä»»å‹™æ—¥æœŸï¼š2026-02-06 (å…¬å¸ç«¯ Gemini)

### ğŸš€ å·²å®ŒæˆåŠŸèƒ½èˆ‡ä¿®æ­£
1.  **Admin å¾Œå°è¨‚å–®è™•ç†**ï¼š
    - æª”æ¡ˆï¼š`admin/index.php`, `admin/api/update_order_status.php`
    - åŠŸèƒ½ï¼šå¢åŠ ã€Œå‡ºè²¨ã€èˆ‡ã€Œç°½æ”¶ã€æŒ‰éˆ•ï¼Œæ”¯æ´ `PENDING` -> `SHIPPED` -> `RECEIVED` ç‹€æ…‹æµè½‰ã€‚
2.  **Admin ç”¨æˆ¶ç®¡ç† (RBAC)**ï¼š
    - æª”æ¡ˆï¼š`admin/users.php`, `admin/api/update_user_role.php`
    - åŠŸèƒ½ï¼šæ”¯æ´ç›´æ¥åœ¨ç¶²é ä¸‹æ‹‰é¸å–®ä¿®æ”¹ç”¨æˆ¶æ¬Šé™ï¼ˆADMIN_WAREHOUSE, ADMIN_OFFICE, SALES_LECTURERï¼‰ã€‚
    - æ ¸å¿ƒå„ªåŒ–ï¼š**æ··åˆè³‡æ–™ä¾†æº (Hybrid Data Source)**ã€‚åˆä½µ Analytics JSON ç´€éŒ„èˆ‡ MySQL `users` è¡¨ï¼Œè§£æ±ºè‹¥ç„¡äº’å‹•ç´€éŒ„å‰‡çœ‹ä¸åˆ°ç”¨æˆ¶çš„å•é¡Œã€‚
3.  **ä¸‹å–®é€šçŸ¥é‚è¼¯ä¿®æ­£**ï¼š
    - æª”æ¡ˆï¼š`liff/api_process_restock.php`
    - ä¿®æ­£ï¼šä¸å†å¯«æ­» User IDï¼Œç¾åœ¨æœƒæŸ¥è©¢æ‰€æœ‰å…·ç®¡ç†æ¬Šé™çš„äººä¸¦ç™¼é€ Flex Message é€šçŸ¥ã€‚
4.  **åœ–ç‰‡é™¤éŒ¯å¢å¼·**ï¼š
    - æª”æ¡ˆï¼š`handlers/MainHandler.php`
    - ä¿®æ­£ï¼šç”¨æˆ¶å‚³åœ–æ™‚æœƒå›å ± `messageId` èˆ‡ä¼ºæœå™¨ä¸Šçš„ `filename`ï¼Œæ–¹ä¾¿é™¤éŒ¯ã€‚

---

### âš ï¸ é‡è¦ç’°å¢ƒå‘é» (å¿…è®€)

1.  **è·¨å¹³å°ç·¨ç¢¼é™·é˜± (Windows -> Linux SSH)**ï¼š
    - **å•é¡Œ**ï¼šç›´æ¥ä½¿ç”¨ `cat file | ssh "cat > remote"` æœƒå°è‡´ç·¨ç¢¼è®Šç‚º UTF-16 æˆ–ç”¢ç”Ÿä¸å¯è¦‹å­—å…ƒï¼Œé€ æˆ PHP å ±éŒ¯ã€Œunexpected '/'ã€æˆ– HTML å‡ºç¾ `?? ???` äº‚ç¢¼ã€‚
    - **è§£æ±ºæ–¹æ¡ˆ**ï¼šæ°¸é ä½¿ç”¨ **Base64 å®‰å…¨å‚³æª”æµç¨‹**ã€‚
        1. æœ¬åœ°ï¼š`powershell "[Convert]::ToBase64String([IO.File]::ReadAllBytes('local_path'))" | Out-File temp.b64`
        2. é ç«¯ï¼š`cat temp.b64 | ssh lt4 "tr -d '\r\n' | base64 -d > remote_path"`
    - **é‡è¦**ï¼šå¦‚æœç™¼ç¾é é¢ç©ºç™½ï¼Œå…ˆæª¢æŸ¥é ç«¯ `php -l` æ˜¯å¦èªæ³•éŒ¯èª¤ã€‚

2.  **è¨­å®šæª”æ ¼å¼ä¸ä¸€**ï¼š
    - `warehouse` æ©Ÿå™¨äººä½¿ç”¨ `return array()`ã€‚
    - `dietitian` æ©Ÿå™¨äººä½¿ç”¨ `define()` å¸¸æ•¸ã€‚
    - `admin/users.php` å·²å¯¦ä½œå…¼å®¹é‚è¼¯ï¼Œä¿®æ”¹æ™‚è«‹ç¢ºä¿ä¸è¦ç ´å£ `include` çš„åŒ¿åå‡½æ•¸ä½œç”¨åŸŸã€‚

3.  **Git ç¶²è·¯ç£ç¢Ÿæ¬Šé™**ï¼š
    - åœ¨ `X:` (NAS) æ“ä½œ Git è‹¥å ±éŒ¯ `dubious ownership`ï¼ŒåŸ·è¡Œï¼š`git config --global --add safe.directory X:/gemini/linebot-warehouse-manager`

---

### ğŸ” å¾…è·Ÿé€²äº‹é …
- æ¸¬è©¦ã€Œå‡ºè²¨ã€æŒ‰éˆ•å¾Œçš„åº«å­˜æ‰£é™¤é‚è¼¯æ˜¯å¦æ­£ç¢ºé€£å‹•ã€‚
- ç›£æ§ `admin/api/update_user_role.php` çš„å®‰å…¨æ€§ï¼ˆç›®å‰åƒ…é  sessionï¼‰ã€‚
- å°åŒ—å€‰ç›¤é»è³‡æ–™é›–ç„¶ç”¨æˆ¶èªªåº«å­˜æ­£ç¢ºï¼Œä½†æœªä¾†è‹¥éœ€å¤§æ‰¹åŒ¯å…¥ï¼Œè«‹åƒè€ƒ `scripts/import_taipei.php`ã€‚